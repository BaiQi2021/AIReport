# GeminiAIReportAgent 工作流程可视化

## 完整处理流程

```
╔══════════════════════════════════════════════════════════════════╗
║                    GeminiAIReportAgent 工作流程                   ║
╚══════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────┐
│                       【阶段 0】数据获取                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐         ┌──────────────┐                     │
│  │  QbitaiArticle│         │CompanyArticle│                     │
│  │   数据表      │         │   数据表      │                     │
│  └──────┬───────┘         └──────┬───────┘                     │
│         │                         │                              │
│         └────────┬────────────────┘                              │
│                  ▼                                               │
│         ┌────────────────┐                                       │
│         │  获取最近N天数据 │                                       │
│         │  (days=3)      │                                       │
│         └────────┬───────┘                                       │
│                  │                                               │
│                  ▼                                               │
│         ┌────────────────┐                                       │
│         │ 转换为 NewsItem │                                       │
│         │   对象列表      │                                       │
│         └────────┬───────┘                                       │
│                  │                                               │
└──────────────────┼───────────────────────────────────────────────┘
                   │
                   │ 原始新闻列表 (例如: 200条)
                   ▼
┌─────────────────────────────────────────────────────────────────┐
│                    【阶段 1】过滤 (Filtering)                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  批处理: 20条/批 (共10批)                                         │
│                                                                  │
│  批次 1 ────┐                                                    │
│  批次 2 ────┤                                                    │
│  批次 3 ────┤                                                    │
│    ...      ├──▶ Gemini API ──▶ 判断每条新闻                    │
│  批次 8 ────┤                   - "保留" or "剔除"              │
│  批次 9 ────┤                   - 附带理由                        │
│  批次 10────┘                                                    │
│                                                                  │
│  ┌──────────────────────────────────────────────────┐           │
│  │ 过滤规则:                                         │           │
│  │ ✓ 保留: 技术进展、关键领域、权威来源              │           │
│  │ ✗ 剔除: 商业金融、市场分析、二次解读、信源不明    │           │
│  └──────────────────────────────────────────────────┘           │
│                                                                  │
│  重试机制: 最多3次                                                │
│                                                                  │
└──────────────────┬──────────────────────────────────────────────┘
                   │
                   │ 过滤后新闻列表 (例如: 120条，保留率60%)
                   ▼
┌─────────────────────────────────────────────────────────────────┐
│                    【阶段 2】归类 (Clustering)                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  批处理: 30条/批 (共4批)                                          │
│                                                                  │
│  批次 1 ────┐    已识别事件列表                                   │
│  批次 2 ────┤    ┌─────────────────────┐                        │
│  批次 3 ────┼───▶│ - gpt5_release      │                        │
│  批次 4 ────┘    │ - llama3_1_opensource│                       │
│                  │ - deepmind_alphafold│                        │
│                  └─────────────────────┘                        │
│                           │                                      │
│                           ▼                                      │
│                  Gemini API (语义理解)                           │
│                           │                                      │
│                           ▼                                      │
│                  分配 event_id                                   │
│                  - 同一事件使用相同ID                             │
│                  - 新事件生成新ID                                 │
│                                                                  │
│  ┌──────────────────────────────────────────────────┐           │
│  │ 归类结果示例:                                     │           │
│  │ • gpt5_release: 15条新闻                          │           │
│  │ • llama3_1_opensource: 8条新闻                    │           │
│  │ • gemini2_launch: 12条新闻                        │           │
│  │ • ...                                             │           │
│  └──────────────────────────────────────────────────┘           │
│                                                                  │
└──────────────────┬──────────────────────────────────────────────┘
                   │
                   │ 归类后新闻列表 (120条 → 40个事件)
                   ▼
┌─────────────────────────────────────────────────────────────────┐
│                   【阶段 3】去重 (Deduplication)                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  按事件分组处理 (共40个事件)                                      │
│                                                                  │
│  事件: gpt5_release (15条新闻)                                   │
│  ┌────────────────────────────────────────────┐                 │
│  │ 1. OpenAI 官方博客                          │ ◄── 最权威      │
│  │ 2. 量子位转述                               │                 │
│  │ 3. 某个人推特分析                           │                 │
│  │ 4. 其他媒体报道...                          │                 │
│  └────────────────────────────────────────────┘                 │
│                   │                                              │
│                   ▼                                              │
│            Gemini API 评估                                       │
│                   │                                              │
│                   ▼                                              │
│  ┌────────────────────────────────────────────┐                 │
│  │ 保留: #1 OpenAI 官方博客 (官方核心信源)    │                 │
│  │ 删除: #2, #3, #4 (优先级较低)              │                 │
│  └────────────────────────────────────────────┘                 │
│                                                                  │
│  ┌──────────────────────────────────────────────────┐           │
│  │ 保留优先级:                                       │           │
│  │ 1. 官方核心信源 (官网、arXiv、GitHub)            │           │
│  │ 2. 核心人员解读 (作者、工程师)                   │           │
│  │ 3. 权威技术媒体 (深度报道)                       │           │
│  │ 4. 社交媒体/普通转述 (最低)                      │           │
│  └──────────────────────────────────────────────────┘           │
│                                                                  │
│  对每个事件重复此过程...                                          │
│                                                                  │
└──────────────────┬──────────────────────────────────────────────┘
                   │
                   │ 去重后新闻列表 (40条，每个事件1条)
                   ▼
┌─────────────────────────────────────────────────────────────────┐
│                    【阶段 4】排序 (Ranking)                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  批处理: 20条/批 (共2批)                                          │
│                                                                  │
│  对每条新闻评分:                                                  │
│                                                                  │
│  ┌─────────────────────────────────────────────────┐            │
│  │ 评分维度:                                        │            │
│  │                                                  │            │
│  │ 1. 技术影响力 (tech_impact) [1-5分]             │            │
│  │    权重: 50%                                     │            │
│  │    ├─ 5分: 范式转换 (如 Transformer)            │            │
│  │    ├─ 4分: 重大突破 (如 GPT-4)                  │            │
│  │    ├─ 3分: 显著改进                              │            │
│  │    ├─ 2分: 常规优化                              │            │
│  │    └─ 1分: 微小改进                              │            │
│  │                                                  │            │
│  │ 2. 行业影响范围 (industry_scope) [1-5分]        │            │
│  │    权重: 30%                                     │            │
│  │    ├─ 5分: 全行业                                │            │
│  │    ├─ 4分: 多领域                                │            │
│  │    ├─ 3分: 特定领域                              │            │
│  │    ├─ 2分: 特定任务                              │            │
│  │    └─ 1分: 小众场景                              │            │
│  │                                                  │            │
│  │ 3. 热度 (hype_score) [1-5分]                    │            │
│  │    权重: 20%                                     │            │
│  │    基于 event_count:                             │            │
│  │    ├─ 1-2篇   → 1分                              │            │
│  │    ├─ 3-5篇   → 2分                              │            │
│  │    ├─ 6-10篇  → 3分                              │            │
│  │    ├─ 11-20篇 → 4分                              │            │
│  │    └─ >20篇   → 5分                              │            │
│  └─────────────────────────────────────────────────┘            │
│                                                                  │
│  计算最终评分:                                                    │
│  FinalScore = (tech_impact × 0.5) +                             │
│               (industry_scope × 0.3) +                          │
│               (hype_score × 0.2)                                │
│                                                                  │
│  评级映射:                                                        │
│  ┌────────────────────────────────────────────┐                 │
│  │ FinalScore ≥ 4.2  → S级 (顶级重要)        │                 │
│  │ 3.5 ≤ FinalScore < 4.2 → A级 (非常重要)   │                 │
│  │ 2.8 ≤ FinalScore < 3.5 → B级 (重要)       │                 │
│  │ FinalScore < 2.8  → C级 (一般)            │                 │
│  └────────────────────────────────────────────┘                 │
│                                                                  │
│  排序结果示例:                                                    │
│  ┌────────────────────────────────────────────┐                 │
│  │ S级: 3条  (例如: GPT-5发布、新架构提出)    │                 │
│  │ A级: 8条  (例如: Llama 3.1、Gemini 2.0)   │                 │
│  │ B级: 15条 (例如: 新工具、优化算法)         │                 │
│  │ C级: 14条 (例如: 小更新、常规迭代)         │                 │
│  └────────────────────────────────────────────┘                 │
│                                                                  │
└──────────────────┬──────────────────────────────────────────────┘
                   │
                   │ 排序后新闻列表 (40条，按评分降序)
                   ▼
┌─────────────────────────────────────────────────────────────────┐
│                 【阶段 5】报告生成 (Report Generation)            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  输入准备:                                                        │
│  ┌────────────────────────────────────────────┐                 │
│  │ 1. 读取报告模板                             │                 │
│  │    templates/AIReport_example.md           │                 │
│  │                                             │                 │
│  │ 2. 格式化新闻数据                           │                 │
│  │    按 S/A/B/C 级别分组                     │                 │
│  │    包含评分、来源、链接等信息               │                 │
│  └────────────────────────────────────────────┘                 │
│                   │                                              │
│                   ▼                                              │
│  构建提示词:                                                      │
│  ┌────────────────────────────────────────────┐                 │
│  │ • 当前日期                                  │                 │
│  │ • 报告模板和格式要求                        │                 │
│  │ • 经过处理的新闻数据                        │                 │
│  │ • 特别指令 (引用规则、风格要求等)           │                 │
│  └────────────────────────────────────────────┘                 │
│                   │                                              │
│                   ▼                                              │
│  Gemini API 生成报告                                             │
│  (temperature=0.3, 平衡创造性和稳定性)                           │
│                   │                                              │
│                   ▼                                              │
│  质量检查 (可选):                                                 │
│  ┌────────────────────────────────────────────┐                 │
│  │ ✓ 检查必需章节是否存在                      │                 │
│  │ ✓ 检查报告长度是否合理                      │                 │
│  │ ✓ 检查格式是否正确                          │                 │
│  └────────────────────────────────────────────┘                 │
│                   │                                              │
│                   ├─ 通过 ──────────────────┐                   │
│                   │                          │                   │
│                   └─ 不通过 ──┐              │                   │
│                                │              │                   │
│                   ┌────────────┘              │                   │
│                   │                           │                   │
│                   ▼                           │                   │
│           添加反馈到提示词                    │                   │
│           重新生成 (最多3轮)                  │                   │
│                   │                           │                   │
│                   └───────────────────────────┘                   │
│                                │                                  │
│                                ▼                                  │
│  保存报告:                                                        │
│  ┌────────────────────────────────────────────┐                 │
│  │ final_reports/AI_Report_2025-12-18.md     │                 │
│  └────────────────────────────────────────────┘                 │
│                                                                  │
└──────────────────┬──────────────────────────────────────────────┘
                   │
                   │
                   ▼
┌─────────────────────────────────────────────────────────────────┐
│                         最终输出                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  📄 高质量 Markdown 报告                                          │
│                                                                  │
│  结构:                                                            │
│  ┌────────────────────────────────────────────┐                 │
│  │ # AI前沿动态速报 (2025-12-18)              │                 │
│  │                                             │                 │
│  │ ## 本周焦点                                 │                 │
│  │ ### [S级] GPT-5 正式发布                   │                 │
│  │ - 评分: 4.8                                 │                 │
│  │ - 来源: OpenAI                              │                 │
│  │ - 深度解读...                               │                 │
│  │                                             │                 │
│  │ ## 重要进展                                 │                 │
│  │ ### [A级] Llama 3.1 开源                   │                 │
│  │ ### [A级] Gemini 2.0 发布                  │                 │
│  │ ...                                         │                 │
│  │                                             │                 │
│  │ ## 其他动态                                 │                 │
│  │ [B级和C级新闻]                              │                 │
│  │                                             │                 │
│  │ ## 趋势分析                                 │                 │
│  │ [基于所有新闻的深度分析]                   │                 │
│  └────────────────────────────────────────────┘                 │
│                                                                  │
│  可选: 中间结果文件                                               │
│  ┌────────────────────────────────────────────┐                 │
│  │ final_reports/intermediate/                │                 │
│  │ ├─ 01_filtered_*.json                      │                 │
│  │ ├─ 02_clustered_*.json                     │                 │
│  │ ├─ 03_deduplicated_*.json                  │                 │
│  │ └─ 04_ranked_*.json                        │                 │
│  └────────────────────────────────────────────┘                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘


╔══════════════════════════════════════════════════════════════════╗
║                        处理统计示例                               ║
╠══════════════════════════════════════════════════════════════════╣
║                                                                   ║
║  原始新闻:        200条                                           ║
║  ↓ 过滤后:        120条 (保留率: 60%)                            ║
║  ↓ 归类后:        120条 → 40个事件                               ║
║  ↓ 去重后:         40条 (每个事件1条)                            ║
║  ↓ 排序后:         40条 (S:3, A:8, B:15, C:14)                   ║
║  ↓ 最终报告:      1份高质量报告                                  ║
║                                                                   ║
║  处理时间:        约 3-5 分钟                                     ║
║  API 调用:        约 20 次                                        ║
║                                                                   ║
╚══════════════════════════════════════════════════════════════════╝
```

## 数据流转示意图

```
┌──────────┐
│ 数据库   │ 200条新闻
└────┬─────┘
     │
     ▼
┌──────────┐
│ 过滤     │ 保留 60% (120条)
└────┬─────┘
     │
     ▼
┌──────────┐
│ 归类     │ 聚合为 40个事件
└────┬─────┘
     │
     ▼
┌──────────┐
│ 去重     │ 每个事件保留1条 (40条)
└────┬─────┘
     │
     ▼
┌──────────┐
│ 排序     │ S:3, A:8, B:15, C:14
└────┬─────┘
     │
     ▼
┌──────────┐
│ 报告     │ 1份 Markdown 文档
└──────────┘
```

## 评分分布示例

```
评分分布:

S级 ████████████████████████████████████████████████ 4.8
    ██████████████████████████████████████████████ 4.6
    ████████████████████████████████████████████ 4.4

A级 ████████████████████████████████████████ 4.0
    ██████████████████████████████████████ 3.9
    ████████████████████████████████████ 3.8
    ██████████████████████████████████ 3.7
    ...

B级 ████████████████████████████████ 3.4
    ██████████████████████████████ 3.2
    ████████████████████████████ 3.0
    ...

C级 ████████████████████████ 2.6
    ██████████████████████ 2.4
    ████████████████████ 2.2
    ...
```

---

## 时间消耗分解

以处理 200 条新闻为例：

| 阶段 | 批次数 | 每批时间 | 总时间 | 占比 |
|------|--------|---------|--------|------|
| 数据获取 | - | - | 2秒 | 1% |
| 过滤 | 10批 × 20条 | 3秒 | 30秒 | 10% |
| 归类 | 4批 × 30条 | 8秒 | 32秒 | 11% |
| 去重 | 40个事件 | 2秒 | 80秒 | 27% |
| 排序 | 2批 × 20条 | 4秒 | 8秒 | 3% |
| 报告生成 | 1次 | - | 120秒 | 40% |
| 其他 | - | - | 28秒 | 9% |
| **总计** | - | - | **~5分钟** | **100%** |

---

## 批处理策略

```
批处理大小选择:

过小 (10条/批):
  ✗ API 调用次数多
  ✗ 总时间长
  ✓ 单次失败影响小

适中 (20-30条/批):
  ✓ 平衡性好
  ✓ 效率高
  ✓ 可靠性好

过大 (100条/批):
  ✗ 容易超时
  ✗ Token 限制
  ✗ 单次失败影响大
```

---

## 质量保证流程

```
┌─────────────┐
│ LLM 生成结果 │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ JSON 解析   │ ─── 失败 ──┐
└──────┬──────┘             │
       │                    │
       │ 成功               │
       ▼                    │
┌─────────────┐             │
│ 格式验证    │ ─── 失败 ──┤
└──────┬──────┘             │
       │                    │
       │ 通过               │
       ▼                    │
┌─────────────┐             │
│ 逻辑检查    │ ─── 失败 ──┤
└──────┬──────┘             │
       │                    │
       │ 通过               │
       ▼                    │
┌─────────────┐             │
│ 使用结果    │             │
└─────────────┘             │
                            │
       ┌────────────────────┘
       │
       ▼
┌─────────────┐
│ 重试机制    │ (最多3次)
│ - 记录日志  │
│ - 调整参数  │
│ - 回退策略  │
└─────────────┘
```

---

这个可视化流程展示了 GeminiAIReportAgent 的完整工作流程，
从数据获取到最终报告生成的每一个步骤。

